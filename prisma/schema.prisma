generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// ENUMS (UNCHANGED)
//////////////////////////////////////////////////////

enum UserRole {
  SUPER_ADMIN
  ADMIN
  SALES
}

enum CustomerStatus {
  NEW
  CALL_PENDING
  CALLING
  INTERESTED
  NOT_INTERESTED
  FOLLOW_UP
  DO_NOT_CALL
  CONVERTED
  CALL_FAILED
  RETRY_SCHEDULED
}

enum CallDirection {
  OUTBOUND
  INBOUND
}

enum CallStatus {
  QUEUED
  INITIATED
  ANSWERED
  NO_ANSWER
  FAILED
  COMPLETED
}

enum TaskStatus {
  OPEN
  DONE
  CANCELLED
}

enum AiProviderType {
  OPENAI
  DIALOGFLOW
  RASA
  GENERIC_HTTP
}

enum TelephonyProviderType {
  TWILIO
  VONAGE
  PLIVO
}

enum CampaignJobStatus {
  QUEUED
  ACTIVE
  COMPLETED
  FAILED
  SKIPPED
}

//////////////////////////////////////////////////////
// üè¢ TENANT ‚Äî CORE SAAS MODEL
//////////////////////////////////////////////////////

model Tenant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  crmName     String?  // Override for CRM display name
  isActive    Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  customers   Customer[]
  callLogs    CallLog[]
  themes      TenantTheme[]
  roles       RoleDefinition[]
  leadUploads LeadUpload[]
}

//////////////////////////////////////////////////////
// üé® TENANT THEME (WHITE LABEL READY)
//////////////////////////////////////////////////////

model TenantTheme {
  id                   String   @id @default(cuid())
  tenantId             String
  primaryColor         String   @default("#2563eb")
  secondaryColor       String   @default("#64748b")
  accentColor          String   @default("#22c55e")
  logoUrl              String?
  faviconUrl           String?
  loginBackgroundUrl   String?
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, isActive])
}

//////////////////////////////////////////////////////
// üë§ USER (UPDATED ‚Äî MULTI TENANT)
//////////////////////////////////////////////////////

model User {
  id           String   @id @default(cuid())
  tenantId     String?  // NULL for SUPER_ADMIN
  name         String
  email        String   @unique
  passwordHash String
  role         UserRole @default(SALES)
  customRoleId String?
  isActive     Boolean  @default(true)
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant       Tenant? @relation(fields: [tenantId], references: [id])

  uploads      LeadUpload[]
  assigned     Customer[]     @relation("CustomerAssignee")
  followUps    FollowUpTask[]
  customRole   RoleDefinition? @relation("RoleUsers", fields: [customRoleId], references: [id])
  authoredUserAuditLogs UserManagementAuditLog[] @relation("UserAuditActor")
  targetUserAuditLogs   UserManagementAuditLog[] @relation("UserAuditTarget")

  @@index([tenantId])
}

//////////////////////////////////////////////////////
// üõ° ROLE DEFINITION (TENANT SCOPED)
//////////////////////////////////////////////////////

model RoleDefinition {
  id             String   @id @default(cuid())
  tenantId       String?
  key            String
  name           String
  description    String?
  baseRole       UserRole @default(SALES)
  modules        Json?
  permissions    Json?
  featureToggles Json?
  active         Boolean  @default(true)
  isSystem       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id])
  users  User[]  @relation("RoleUsers")

  @@unique([tenantId, key])
  @@index([tenantId, active])
}

//////////////////////////////////////////////////////
// üì• LEAD UPLOAD (TENANT SAFE)
//////////////////////////////////////////////////////

model LeadUpload {
  id           String   @id @default(cuid())
  tenantId     String
  fileName     String
  totalRows    Int
  successRows  Int
  failedRows   Int
  uploadedAt   DateTime @default(now())
  uploadedById String

  tenant     Tenant @relation(fields: [tenantId], references: [id])
  uploadedBy User   @relation(fields: [uploadedById], references: [id])

  @@index([tenantId, uploadedAt])
}

//////////////////////////////////////////////////////
// üë• CUSTOMER (CRITICAL MULTI-TENANT FIXES)
//////////////////////////////////////////////////////

model Customer {
  id              String         @id @default(cuid())
  tenantId        String
  firstName       String
  lastName        String?
  phone           String
  email           String?
  city            String?
  state           String?
  source          String?
  loanType        String?
  loanAmount      Float?
  monthlyIncome   Float?
  status          CustomerStatus @default(NEW)
  retryCount      Int            @default(0)
  maxRetries      Int            @default(3)
  inActiveCall    Boolean        @default(false)
  nextFollowUpAt  DateTime?
  manualReview    Boolean        @default(false)
  aiSummary       String?
  aiIntent        String?
  notes           String?
  archivedAt      DateTime?
  lastContactedAt DateTime?
  assignedToId    String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  tenant     Tenant @relation(fields: [tenantId], references: [id])
  assignedTo User?  @relation("CustomerAssignee", fields: [assignedToId], references: [id])

  calls        CallLog[]
  campaignJobs CampaignJob[]
  transitions  CustomerTransition[]
  followUps    FollowUpTask[]

  // üö® IMPORTANT: SaaS-safe uniqueness
  @@unique([tenantId, phone])

  @@index([tenantId, status, retryCount, inActiveCall])
  @@index([tenantId, nextFollowUpAt])
}

//////////////////////////////////////////////////////
// üìû CALL LOG (TENANT SAFE)
//////////////////////////////////////////////////////

model CallLog {
  id             String        @id @default(cuid())
  tenantId       String
  customerId     String
  providerCallId String?       @unique
  aiProviderUsed String?
  telephonyProviderUsed String?
  telephonyProviderType TelephonyProviderType?
  direction      CallDirection @default(OUTBOUND)
  status         CallStatus    @default(QUEUED)
  mode           String        @default("AI")
  attemptNumber  Int           @default(1)
  transcript     String?
  summary        String?
  intent         String?
  intentClassification String?
  nextAction     String?
  durationSecs   Int?
  recordingUrl   String?
  metadata       Json?
  errorReason    String?
  startedAt      DateTime?
  endedAt        DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])

  @@index([tenantId, customerId, createdAt])
}

model UserManagementAuditLog {
  id           String   @id @default(cuid())
  action       String
  actorUserId  String?
  targetUserId String?
  metadata     Json?
  createdAt    DateTime @default(now())
  actor        User?    @relation("UserAuditActor", fields: [actorUserId], references: [id])
  targetUser   User?    @relation("UserAuditTarget", fields: [targetUserId], references: [id])

  @@index([createdAt])
  @@index([action, createdAt])
  @@index([targetUserId, createdAt])
}

model CustomerTransition {
  id            String         @id @default(cuid())
  customerId    String
  fromStatus    CustomerStatus?
  toStatus      CustomerStatus
  reason        String?
  source        String
  transitionKey String         @unique
  metadata      Json?
  createdAt     DateTime       @default(now())
  customer      Customer       @relation(fields: [customerId], references: [id])

  @@index([customerId, createdAt])
}

model AutomationSetting {
  key       String   @id
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AiProviderConfig {
  id        String         @id @default(cuid())
  name      String         @unique
  type      AiProviderType
  endpoint  String?
  apiKey    String?
  model     String?
  priority  Int            @default(100)
  enabled   Boolean        @default(true)
  isActive  Boolean        @default(false)
  timeoutMs Int            @default(12000)
  metadata  Json?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([enabled, isActive, priority])
}

model FollowUpTask {
  id           String     @id @default(cuid())
  customerId   String
  assignedToId String
  dueDate      DateTime
  status       TaskStatus @default(OPEN)
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  customer     Customer   @relation(fields: [customerId], references: [id])
  assignedTo   User       @relation(fields: [assignedToId], references: [id])
}

model TelephonyProviderConfig {
  id        String                @id @default(cuid())
  name      String                @unique
  type      TelephonyProviderType
  endpoint  String?
  apiKey    String?
  model     String?
  priority  Int                   @default(100)
  enabled   Boolean               @default(true)
  isActive  Boolean               @default(false)
  timeoutMs Int                   @default(12000)
  metadata  Json?
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@index([enabled, isActive, priority])
}

model CampaignJob {
  id           String            @id @default(cuid())
  queueJobId   String            @unique
  customerId   String?
  reason       String
  status       CampaignJobStatus @default(QUEUED)
  attemptsMade Int               @default(0)
  enqueuedAt   DateTime          @default(now())
  startedAt    DateTime?
  completedAt  DateTime?
  failedAt     DateTime?
  errorMessage String?
  result       Json?
  metadata     Json?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  customer     Customer?         @relation(fields: [customerId], references: [id])

  @@index([status, createdAt])
  @@index([customerId, createdAt])
}